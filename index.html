<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cockpit Cosmique ‚Äî Monde Souterrain</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: system-ui, sans-serif; background: #0a0a0f; color: #ddd; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #222; }
    header .actions { display:flex; gap:8px; }
    main { padding:16px; display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { background:#121219; border:1px solid #1f1f2a; border-radius:12px; padding:12px; box-shadow: 0 0 20px rgba(0,0,0,.25); }
    h3 { margin:0 0 8px; font-weight:600; color:#aaf; }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    button { background:#1c1c29; color:#eaeaf6; border:1px solid #2a2a3a; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button:hover { background:#25253a; }
    canvas { width:100%; height:220px; background:#0d0d14; border-radius:8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .hidden { display:none; }
    .metric { display:flex; justify-content:space-between; padding:4px 0; }
    .metric strong { color:#9cf; }
    footer { padding:16px; text-align:center; color:#888; }
  </style>
</head>
<body>
  <header>
    <div class="mono">Cockpit Cosmique ‚Ä¢ Monde souterrain</div>
    <div class="actions">
      <button id="btnAmbient">Ambiance</button>
      <button id="btnExportGlobal">Exporter journal</button>
      <button id="btnInstall" class="hidden">Installer</button>
    </div>
  </header>

  <main>
    <!-- ... tes sections inchang√©es ... -->

    <!-- Journal rituel global -->
    <section class="card">
      <h3>üìú Journal rituel</h3>
      <div id="log" class="mono"></div>
      <div class="row">
        <button id="btnExportGlobal2">Exporter JSON</button>
      </div>
    </section>

    <!-- Journal souterrain -->
    <section class="card">
      <h3>üìì Journal souterrain</h3>
      <div id="logSouterrain" class="mono"></div>
      <div class="row">
        <button onclick="exportJournalSouterrain()">Exporter</button>
        <button onclick="rejouerJournalSouterrain()">Rejouer</button>
      </div>
    </section>

    <!-- ... reste identique ... -->
  </main>

  <footer>¬© Ton univers ‚Äî du noyau √† la couronne</footer>

  <!-- Scripts utilitaires (Bus, Pref, log) -->
  <script>
    window.Bus = (function(){
      const map = {};
      return {
        on: (ev, fn) => (map[ev] = (map[ev]||[])).push(fn),
        emit: (ev, data) => (map[ev]||[]).forEach(fn => fn(data))
      };
    })();
    window.Pref = {
      get: (k, d) => { try { return JSON.parse(localStorage.getItem('pref:'+k)) ?? d; } catch { return d; } },
      set: (k, v) => localStorage.setItem('pref:'+k, JSON.stringify(v))
    };
    function log(msg) {
      const el = document.createElement('div');
      el.textContent = `${new Date().toISOString()} ‚Äî ${msg}`;
      document.getElementById('log')?.prepend(el);
      const arr = JSON.parse(localStorage.getItem('journalRituel') || '[]');
      arr.push({ event: msg, at: new Date().toISOString() });
      localStorage.setItem('journalRituel', JSON.stringify(arr));
    }
  </script>

  <!-- Ton script vitesse + capteurs -->
  <script type="module">
    /* ... ton code vitesse.js adapt√© ... */

    // Correction export global (boutons renomm√©s)
    document.getElementById('btnExportGlobal').addEventListener('click', exportJournalGlobal);
    document.getElementById('btnExportGlobal2').addEventListener('click', exportJournalGlobal);
    function exportJournalGlobal() {
      const j = localStorage.getItem('journalRituel') || '[]';
      const blob = new Blob([j], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'journal-rituel-cosmique.json';
      a.click();
    }
  </script>

  <!-- Ambiance sonore, orbit, PWA -->
  <script>
    /* ... ton script ambiance + orbit + souterrain ... */

    // Audio bus stub (accolade ferm√©e correctement)
    Bus.on('audio:play', ({ id, vol=0.4, loop=false }) => {
      try {
        const a = new Audio(`sons/${id}.mp3`);
        a.loop = loop; a.volume = vol; a.play();
      } catch {}
    });

    // Service Worker unique et bien ferm√©
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('‚úÖ Service Worker enregistr√©'))
        .catch(err => console.warn('‚ùå SW erreur', err));
    }
  </script>
</body>
</html>
